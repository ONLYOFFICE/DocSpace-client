name: Frontend common tests

on:
  push:
    branches: [develop, release/v*, hotfix/v*]
    paths: [packages/**, common/**, .github/workflows/frontend-common-tests.yaml]
  pull_request:
    branches: [develop, release/v*, hotfix/v*]
    paths: [packages/**, common/**, .github/workflows/frontend-common-tests.yaml]

env:
  NODE_VERSION: 22.x
  PNPM_VERSION: 10.15.1

jobs:
  # Detect changes to optimize job execution
  changes:
    name: "Detect changes"
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.changes.outputs.packages }}
      common: ${{ steps.changes.outputs.common }}
      playwright: ${{ steps.changes.outputs.playwright }}
      locales: ${{ steps.changes.outputs.locales }}
      workflow: ${{ steps.changes.outputs.workflow }}
      any_changes: ${{ steps.changes.outputs.any_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect file changes
        id: changes
        run: |
          # Get the base branch for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi
          
          # If BASE_SHA is empty or all zeros, compare with HEAD~1
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="HEAD~1"
          fi
          
          echo "Comparing against: $BASE_SHA"
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD || echo "")
          echo "Changed files: $CHANGED_FILES"
          
          # Check for packages changes
          if echo "$CHANGED_FILES" | grep -q "^packages/"; then
            echo "packages=true" >> $GITHUB_OUTPUT
            echo "✅ Packages changes detected"
          else
            echo "packages=false" >> $GITHUB_OUTPUT
            echo "❌ No packages changes"
          fi
          
          # Check for common changes
          if echo "$CHANGED_FILES" | grep -q "^common/"; then
            echo "common=true" >> $GITHUB_OUTPUT
            echo "✅ Common changes detected"
          else
            echo "common=false" >> $GITHUB_OUTPUT
            echo "❌ No common changes"
          fi
          
          # Check for playwright changes
          if echo "$CHANGED_FILES" | grep -E "^packages/(login|sdk)/"; then
            echo "playwright=true" >> $GITHUB_OUTPUT
            echo "✅ Playwright changes detected"
          else
            echo "playwright=false" >> $GITHUB_OUTPUT
            echo "❌ No playwright changes"
          fi
          
          # Check for locales changes
          if echo "$CHANGED_FILES" | grep -E "(public/locales/|common/tests/)"; then
            echo "locales=true" >> $GITHUB_OUTPUT
            echo "✅ Locales changes detected"
          else
            echo "locales=false" >> $GITHUB_OUTPUT
            echo "❌ No locales changes"
          fi
          
          # Check for workflow changes
          if echo "$CHANGED_FILES" | grep -q "^\.github/workflows/"; then
            echo "workflow=true" >> $GITHUB_OUTPUT
            echo "✅ Workflow changes detected"
          else
            echo "workflow=false" >> $GITHUB_OUTPUT
            echo "❌ No workflow changes"
          fi
          
          # Set any_changes flag
          if echo "$CHANGED_FILES" | grep -E "(^packages/|^common/|^\.github/workflows/)"; then
            echo "any_changes=true" >> $GITHUB_OUTPUT
            echo "✅ Any relevant changes detected"
          else
            echo "any_changes=false" >> $GITHUB_OUTPUT
            echo "❌ No relevant changes detected"
          fi

  # Setup dependencies once for reuse
  setup:
    name: "Setup dependencies"
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.packages == 'true' || needs.changes.outputs.common == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Cache installed dependencies
        uses: actions/cache/save@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ github.run_id }}

  # Playwright Login tests
  playwright-login:
    name: "Login e2e tests"
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.playwright == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Cleanup existing containers
        run: docker ps -a --filter name=login-tests-ci -q | xargs -r docker rm -f
      - uses: adambirds/docker-compose-action@v1.5.0
        with:
          compose-file: packages/login/compose.yaml
          up-flags: --build --remove-orphans
          down-flags: --volumes --remove-orphans
          services: tests-ci
          test-container: tests-ci
          test-command: pnpm exec playwright test --workers=1
          environment: |
            CI=true
            GITHUB_WORKFLOW=${{ github.workflow }}
            GITHUB_RUN_ID=${{ github.run_id }}
            GITHUB_RUN_NUMBER=${{ github.run_number }}
            BUILDKIT_INLINE_CACHE=1

  # Playwright SDK tests
  playwright-sdk:
    name: "SDK e2e tests"
    runs-on: ubuntu-latest
    needs: [playwright-login]
    if: needs.changes.outputs.playwright == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 12
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Cleanup existing containers
        run: docker ps -a --filter name=sdk-tests-ci -q | xargs -r docker rm -f
      - uses: adambirds/docker-compose-action@v1.5.0
        with:
          compose-file: packages/sdk/compose.yaml
          up-flags: --build --remove-orphans
          down-flags: --volumes --remove-orphans
          services: tests-ci
          test-container: tests-ci
          test-command: pnpm exec playwright test --workers=1
          environment: |
            CI=true
            GITHUB_WORKFLOW=${{ github.workflow }}
            GITHUB_RUN_ID=${{ github.run_id }}
            GITHUB_RUN_NUMBER=${{ github.run_number }}
            BUILDKIT_INLINE_CACHE=1
  # ESLint tests
  eslint:
    name: "Lint tests"
    runs-on: ubuntu-latest
    needs: [setup, playwright-sdk]
    if: needs.setup.result == 'success'
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Restore cached dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ github.run_id }}
          fail-on-cache-miss: true
      - name: Run lint
        run: pnpm lint

  # TypeScript tests
  tsc:
    name: "TypeScript tests"
    runs-on: ubuntu-latest
    needs: [eslint]
    if: needs.setup.result == 'success'
    timeout-minutes: 6
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Restore cached dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ github.run_id }}
          fail-on-cache-miss: true
      - name: Run tsc
        run: pnpm tsc

  # Unit tests
  unit-tests:
    name: "Unit tests"
    runs-on: ubuntu-latest
    needs: [tsc]
    if: needs.setup.result == 'success'
    timeout-minutes: 8
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Restore cached dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ github.run_id }}
          fail-on-cache-miss: true
      - name: Run unit tests
        run: pnpm test
  # Images tests
  images:
    name: "Images tests"
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: needs.changes.outputs.common == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ./common/tests/package-lock.json
      - name: Install dependencies
        working-directory: ./common/tests
        run: npm ci --prefer-offline
      - name: Run images tests
        working-directory: ./common/tests
        run: npm run test:images

  # Colors tests
  colors:
    name: "Colors tests"
    runs-on: ubuntu-latest
    needs: [images]
    if: needs.changes.outputs.common == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ./common/tests/package-lock.json
      - name: Install dependencies
        working-directory: ./common/tests
        run: npm ci --prefer-offline
      - name: Run colors tests
        working-directory: ./common/tests
        run: npm run test:colors

  # Dependency audit and tests
  dependencies:
    name: "Dependencies Audit"
    runs-on: ubuntu-latest
    needs: [colors]
    if: needs.setup.result == 'success'
    timeout-minutes: 6
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Restore cached dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            packages/*/node_modules
          key: deps-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ github.run_id }}
          fail-on-cache-miss: true
      - name: Run audit
        run: pnpm audit --audit-level=moderate
        env:
          CI: true
      - name: Install common test dependencies
        working-directory: ./common/tests
        run: npm ci --prefer-offline
      - name: Run dependency tests
        working-directory: ./common/tests
        run: npm run test:dependencies

  # Locales tests
  locales:
    name: "Locales Tests"
    runs-on: ubuntu-latest
    needs: [dependencies]
    if: needs.changes.outputs.locales == 'true' || needs.changes.outputs.common == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 4
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: ./common/tests/package-lock.json
      - name: Install dependencies
        working-directory: ./common/tests
        run: npm ci --prefer-offline
      - name: Run locales tests
        working-directory: ./common/tests
        run: npm run test:skip-base-languages

  # Summary job to report overall status
  test-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    needs: [changes, setup, playwright-login, playwright-sdk, eslint, tsc, unit-tests, images, colors, dependencies, locales]
    if: always()
    timeout-minutes: 2
    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Detection | ${{ needs.changes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Setup Dependencies | ${{ needs.setup.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Playwright Login | ${{ needs.playwright-login.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Playwright SDK | ${{ needs.playwright-sdk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ needs.eslint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ needs.tsc.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Images Tests | ${{ needs.images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Colors Tests | ${{ needs.colors.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies Audit | ${{ needs.dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Locales Tests | ${{ needs.locales.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Check if any critical job failed
          if [[ "${{ needs.setup.result }}" == "failure" ]] || 
             [[ "${{ needs.eslint.result }}" == "failure" ]] || 
             [[ "${{ needs.tsc.result }}" == "failure" ]] || 
             [[ "${{ needs.unit-tests.result }}" == "failure" ]] || 
             [[ "${{ needs.dependencies.result }}" == "failure" ]]; then
            echo "❌ Critical tests failed"
            exit 1
          elif [[ "${{ needs.playwright-login.result }}" == "failure" ]] || 
                [[ "${{ needs.playwright-sdk.result }}" == "failure" ]] || 
                [[ "${{ needs.images.result }}" == "failure" ]] || 
                [[ "${{ needs.colors.result }}" == "failure" ]] || 
                [[ "${{ needs.locales.result }}" == "failure" ]]; then
            echo "⚠️ Some tests failed, but build can continue"
            exit 0
          else
            echo "✅ All tests passed successfully"
            exit 0
          fi
