name: Frontend common tests

on:
  push:
    branches: [develop, release/v*, hotfix/v*]
    paths:
      [packages/**, common/**, .github/workflows/frontend-common-tests.yaml]
  pull_request:
    branches: [develop, release/v*, hotfix/v*]
    paths:
      [packages/**, common/**, .github/workflows/frontend-common-tests.yaml]

env:
  NODE_VERSION: 22.x
  PNPM_VERSION: 10.15.1

jobs:
  # Detect changes to optimize job execution
  changes:
    name: "Detect changes"
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.changes.outputs.packages }}
      common: ${{ steps.changes.outputs.common }}
      playwright: ${{ steps.changes.outputs.playwright }}
      locales: ${{ steps.changes.outputs.locales }}
      workflow: ${{ steps.changes.outputs.workflow }}
      any_changes: ${{ steps.changes.outputs.any_changes }}
      changed_files: ${{ steps.changes.outputs.changed_files }}
      lint: ${{ steps.changes.outputs.packages }}
      tsc: ${{ steps.changes.outputs.packages }}
      unit-tests: ${{ steps.changes.outputs.packages }}
      images: ${{ steps.changes.outputs.common }}
      colors: ${{ steps.changes.outputs.common }}
      dependencies: ${{ steps.changes.outputs.packages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect file changes
        id: changes
        run: |
          # Get the base branch for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          # If BASE_SHA is empty or all zeros, compare with HEAD~1
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="HEAD~1"
          fi

          echo "Comparing against: $BASE_SHA"

          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD || echo "")
          echo "Changed files: $CHANGED_FILES"

          # Check for packages changes
          if echo "$CHANGED_FILES" | grep -q "^packages/"; then
            echo "packages=true" >> $GITHUB_OUTPUT
            echo "âœ… Packages changes detected"
          else
            echo "packages=false" >> $GITHUB_OUTPUT
            echo "âŒ No packages changes"
          fi

          # Check for common changes
          if echo "$CHANGED_FILES" | grep -q "^common/"; then
            echo "common=true" >> $GITHUB_OUTPUT
            echo "âœ… Common changes detected"
          else
            echo "common=false" >> $GITHUB_OUTPUT
            echo "âŒ No common changes"
          fi

          # Check for playwright changes
          if echo "$CHANGED_FILES" | grep -E "^packages/(login|sdk)/"; then
            echo "playwright=true" >> $GITHUB_OUTPUT
            echo "âœ… Playwright changes detected"
          else
            echo "playwright=false" >> $GITHUB_OUTPUT
            echo "âŒ No playwright changes"
          fi

          # Check for locales changes
          if echo "$CHANGED_FILES" | grep -E "(public/locales/|common/tests/)"; then
            echo "locales=true" >> $GITHUB_OUTPUT
            echo "âœ… Locales changes detected"
          else
            echo "locales=false" >> $GITHUB_OUTPUT
            echo "âŒ No locales changes"
          fi

          # Check for workflow changes
          if echo "$CHANGED_FILES" | grep -q "^\.github/workflows/"; then
            echo "workflow=true" >> $GITHUB_OUTPUT
            echo "âœ… Workflow changes detected"
          else
            echo "workflow=false" >> $GITHUB_OUTPUT
            echo "âŒ No workflow changes"
          fi

          # Set any_changes flag
          if echo "$CHANGED_FILES" | grep -E "(^packages/|^common/|^\.github/workflows/)"; then
            echo "any_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Any relevant changes detected"
          else
            echo "any_changes=false" >> $GITHUB_OUTPUT
            echo "âŒ No relevant changes detected"
          fi

          # Output changed files (encode for safe transport)
          if [ -n "$CHANGED_FILES" ]; then
            # Convert newlines to commas for safe transport
            CHANGED_FILES_ENCODED=$(echo "$CHANGED_FILES" | tr '\n' ',' | sed 's/,$//')
            echo "changed_files=$CHANGED_FILES_ENCODED" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changed files: $CHANGED_FILES_ENCODED"
          else
            echo "changed_files=" >> $GITHUB_OUTPUT
            echo "ðŸ“ No changed files detected"
          fi

  # Combined static analysis and common tests
  static-analysis-and-tests:
    name: "Static Analysis & Tests"
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.packages == 'true' || needs.changes.outputs.common == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 15
    outputs:
      lint_result: ${{ steps.lint.outputs.result }}
      tsc_result: ${{ steps.tsc.outputs.result }}
      unit_tests_result: ${{ steps.unit-tests.outputs.result }}
      images_result: ${{ steps.images.outputs.result }}
      colors_result: ${{ steps.colors.outputs.result }}
      locales_result: ${{ steps.locales.outputs.result }}
      dependencies_result: ${{ steps.dependencies.outputs.result }}
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      # Install all dependencies
      - name: Install pnpm dependencies
        run: pnpm install --frozen-lockfile
      - name: Install common test npm dependencies
        working-directory: ./common/tests
        run: npm ci --prefer-offline

      # Run ESLint (if needed)
      - name: Run ESLint
        id: lint
        if: needs.changes.outputs.lint == 'true' || needs.changes.outputs.workflow == 'true'
        run: |
          echo "ðŸ” Running ESLint..."
          if pnpm lint; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… ESLint passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ ESLint failed"
            exit 1
          fi
        continue-on-error: true

      # Run TypeScript compilation (if needed)
      - name: Run TypeScript compilation
        id: tsc
        if: needs.changes.outputs.tsc == 'true' || needs.changes.outputs.workflow == 'true'
        run: |
          echo "ðŸ”§ Running TypeScript compilation..."
          if pnpm tsc; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… TypeScript compilation passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ TypeScript compilation failed"
            exit 1
          fi
        continue-on-error: true

      # Run images tests (if needed)
      - name: Run images tests
        id: images
        if: needs.changes.outputs.images == 'true' || needs.changes.outputs.workflow == 'true'
        working-directory: ./common/tests
        run: |
          echo "ðŸ–¼ï¸ Running images tests..."
          if npm run test:images; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… Images tests passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Images tests failed"
            exit 1
          fi
        continue-on-error: true

      # Run colors tests (if needed)
      - name: Run colors tests
        id: colors
        if: needs.changes.outputs.colors == 'true' || needs.changes.outputs.workflow == 'true'
        working-directory: ./common/tests
        run: |
          echo "ðŸŽ¨ Running colors tests..."
          if npm run test:colors; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… Colors tests passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Colors tests failed"
            exit 1
          fi
        continue-on-error: true

      # Run locales tests (if needed)
      - name: Run locales tests
        id: locales
        if: needs.changes.outputs.locales == 'true' || needs.changes.outputs.workflow == 'true'
        working-directory: ./common/tests
        run: |
          echo "ðŸŒ Running locales tests..."
          if npm run test:skip-base-languages; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… Locales tests passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Locales tests failed"
            exit 1
          fi
        continue-on-error: true

      # Run dependencies audit and tests (if needed)
      - name: Run dependencies audit and tests
        id: dependencies
        if: needs.changes.outputs.dependencies == 'true' || needs.changes.outputs.workflow == 'true'
        run: |
          echo "ðŸ”’ Running dependencies audit..."
          AUDIT_SUCCESS=true
          DEPS_TEST_SUCCESS=true

          # Run pnpm audit
          if ! pnpm audit --audit-level=moderate; then
            echo "âŒ Dependencies audit failed"
            AUDIT_SUCCESS=false
          else
            echo "âœ… Dependencies audit passed"
          fi

          # Run dependency tests
          echo "ðŸ” Running dependency tests..."
          cd ./common/tests
          if ! npm run test:dependencies; then
            echo "âŒ Dependency tests failed"
            DEPS_TEST_SUCCESS=false
          else
            echo "âœ… Dependency tests passed"
          fi

          # Set overall result
          if [[ "$AUDIT_SUCCESS" == "true" ]] && [[ "$DEPS_TEST_SUCCESS" == "true" ]]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… All dependency checks passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Some dependency checks failed"
            exit 1
          fi
        continue-on-error: true
        env:
          CI: true

      # Run unit tests (if needed)
      - name: Run unit tests
        id: unit-tests
        if: needs.changes.outputs.unit-tests == 'true' || needs.changes.outputs.workflow == 'true'
        run: |
          echo "ðŸ§ª Running unit tests..."
          if pnpm test; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… Unit tests passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Unit tests failed"
            exit 1
          fi
        continue-on-error: true

  # Playwright Login tests
  playwright-login:
    name: "Login e2e tests"
    runs-on: ubuntu-latest
    needs: [changes, static-analysis-and-tests]
    if: needs.changes.outputs.playwright == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Cleanup existing containers
        run: docker ps -a --filter name=login-tests-ci -q | xargs -r docker rm -f
      - uses: adambirds/docker-compose-action@v1.5.0
        with:
          compose-file: packages/login/compose.yaml
          up-flags: --build --force-recreate --remove-orphans
          down-flags: --volumes --remove-orphans
          services: tests-ci
          test-container: tests-ci
          test-command: pnpm exec playwright test
          environment: |
            CI=true
            GITHUB_WORKFLOW=${{ github.workflow }}
            GITHUB_RUN_ID=${{ github.run_id }}
            GITHUB_RUN_NUMBER=${{ github.run_number }}

  # Playwright SDK tests
  playwright-sdk:
    name: "SDK e2e tests"
    runs-on: ubuntu-latest
    needs: [changes, static-analysis-and-tests]
    if: needs.changes.outputs.playwright == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Cleanup existing containers
        run: docker ps -a --filter name=sdk-tests-ci -q | xargs -r docker rm -f
      - uses: adambirds/docker-compose-action@v1.5.0
        with:
          compose-file: packages/sdk/compose.yaml
          up-flags: --build --force-recreate --remove-orphans
          down-flags: --volumes --remove-orphans
          services: tests-ci
          test-container: tests-ci
          test-command: pnpm exec playwright test
          environment: |
            CI=true
            GITHUB_WORKFLOW=${{ github.workflow }}
            GITHUB_RUN_ID=${{ github.run_id }}
            GITHUB_RUN_NUMBER=${{ github.run_number }}

  # Summary job to report overall status
  test-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    needs:
      [changes, static-analysis-and-tests, playwright-login, playwright-sdk]
    if: always()
    timeout-minutes: 2
    steps:
      - name: Check test results
        run: |
          # Create report file
          REPORT_FILE="report.md"

          # Write enhanced test results to both GitHub Step Summary and report file
          {
            echo "# ðŸš€ DocSpace Frontend Test Results"
            echo ""
            echo "**Workflow:** \`${{ github.workflow }}\`"
            echo "**Run ID:** \`${{ github.run_id }}\`"
            echo "**Branch:** \`${{ github.ref_name }}\`"
            echo "**Commit:** \`${{ github.sha }}\`"
            echo "**Triggered by:** \`${{ github.event_name }}\`"
            echo "**Date:** \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`"
            echo ""
            echo "---"
            echo ""
            echo "## ðŸ“ Changes Detection"
            echo ""
            echo "| Change Type | Detected | Status |"
            echo "|-------------|----------|--------|"
            echo "| ðŸ“¦ **Packages** | ${{ needs.changes.outputs.packages }} | $([ '${{ needs.changes.outputs.packages }}' = 'true' ] && echo 'âœ… Yes' || echo 'âŒ No') |"
            echo "| ðŸ”§ **Common** | ${{ needs.changes.outputs.common }} | $([ '${{ needs.changes.outputs.common }}' = 'true' ] && echo 'âœ… Yes' || echo 'âŒ No') |"
            echo "| ðŸŽ­ **Playwright** | ${{ needs.changes.outputs.playwright }} | $([ '${{ needs.changes.outputs.playwright }}' = 'true' ] && echo 'âœ… Yes' || echo 'âŒ No') |"
            echo "| ðŸŒ **Locales** | ${{ needs.changes.outputs.locales }} | $([ '${{ needs.changes.outputs.locales }}' = 'true' ] && echo 'âœ… Yes' || echo 'âŒ No') |"
            echo "| ðŸ”„ **Workflow** | ${{ needs.changes.outputs.workflow }} | $([ '${{ needs.changes.outputs.workflow }}' = 'true' ] && echo 'âœ… Yes' || echo 'âŒ No') |"
            echo "| ðŸ“‹ **Any Changes** | ${{ needs.changes.outputs.any_changes }} | $([ '${{ needs.changes.outputs.any_changes }}' = 'true' ] && echo 'âœ… Yes' || echo 'âŒ No') |"
            echo ""
            
            # Add changed files section
            CHANGED_FILES_RAW="${{ needs.changes.outputs.changed_files }}"
            if [ -n "$CHANGED_FILES_RAW" ]; then
              echo "### ðŸ“ Changed Files"
              echo ""
              echo "\`\`\`"
              # Convert comma-separated back to newlines for display
              echo "$CHANGED_FILES_RAW" | tr ',' '\n'
              echo "\`\`\`"
              echo ""
            else
              echo "### ðŸ“ Changed Files"
              echo ""
              echo "_No files changed or unable to detect changes._"
              echo ""
            fi
            echo "## ðŸ“Š Test Results Overview"
            echo ""
            echo "| Test Category | Test Type | Status | Result |"
            echo "|---------------|-----------|--------|--------|"
            echo "| **Setup** | Changes Detection | ${{ needs.changes.result }} | $([ '${{ needs.changes.result }}' = 'success' ] && echo 'âœ… Passed' || echo 'âŒ Failed') |"
            echo "| **Static Analysis** | ðŸ” ESLint | ${{ needs.static-analysis-and-tests.outputs.lint_result || 'skipped' }} | $([ '${{ needs.static-analysis-and-tests.outputs.lint_result }}' = 'success' ] && echo 'âœ… Passed' || [ '${{ needs.static-analysis-and-tests.outputs.lint_result }}' = 'failure' ] && echo 'âŒ Failed' || echo 'â­ï¸ Skipped') |"
            echo "| **Static Analysis** | ðŸ”§ TypeScript | ${{ needs.static-analysis-and-tests.outputs.tsc_result || 'skipped' }} | $([ '${{ needs.static-analysis-and-tests.outputs.tsc_result }}' = 'success' ] && echo 'âœ… Passed' || [ '${{ needs.static-analysis-and-tests.outputs.tsc_result }}' = 'failure' ] && echo 'âŒ Failed' || echo 'â­ï¸ Skipped') |"
            echo "| **Testing** | ðŸ§ª Unit Tests | ${{ needs.static-analysis-and-tests.outputs.unit_tests_result || 'skipped' }} | $([ '${{ needs.static-analysis-and-tests.outputs.unit_tests_result }}' = 'success' ] && echo 'âœ… Passed' || [ '${{ needs.static-analysis-and-tests.outputs.unit_tests_result }}' = 'failure' ] && echo 'âŒ Failed' || echo 'â­ï¸ Skipped') |"
            echo "| **Assets** | ðŸ–¼ï¸ Images Tests | ${{ needs.static-analysis-and-tests.outputs.images_result || 'skipped' }} | $([ '${{ needs.static-analysis-and-tests.outputs.images_result }}' = 'success' ] && echo 'âœ… Passed' || [ '${{ needs.static-analysis-and-tests.outputs.images_result }}' = 'failure' ] && echo 'âŒ Failed' || echo 'â­ï¸ Skipped') |"
            echo "| **Assets** | ðŸŽ¨ Colors Tests | ${{ needs.static-analysis-and-tests.outputs.colors_result || 'skipped' }} | $([ '${{ needs.static-analysis-and-tests.outputs.colors_result }}' = 'success' ] && echo 'âœ… Passed' || [ '${{ needs.static-analysis-and-tests.outputs.colors_result }}' = 'failure' ] && echo 'âŒ Failed' || echo 'â­ï¸ Skipped') |"
            echo "| **Localization** | ðŸŒ Locales Tests | ${{ needs.static-analysis-and-tests.outputs.locales_result || 'skipped' }} | $([ '${{ needs.static-analysis-and-tests.outputs.locales_result }}' = 'success' ] && echo 'âœ… Passed' || [ '${{ needs.static-analysis-and-tests.outputs.locales_result }}' = 'failure' ] && echo 'âŒ Failed' || echo 'â­ï¸ Skipped') |"
            echo "| **Security** | ðŸ”’ Dependencies | ${{ needs.static-analysis-and-tests.outputs.dependencies_result || 'skipped' }} | $([ '${{ needs.static-analysis-and-tests.outputs.dependencies_result }}' = 'success' ] && echo 'âœ… Passed' || [ '${{ needs.static-analysis-and-tests.outputs.dependencies_result }}' = 'failure' ] && echo 'âŒ Failed' || echo 'â­ï¸ Skipped') |"
            echo "| **E2E Testing** | ðŸŽ­ Playwright Login | ${{ needs.playwright-login.result }} | $([ '${{ needs.playwright-login.result }}' = 'success' ] && echo 'âœ… Passed' || echo 'âŒ Failed') |"
            echo "| **E2E Testing** | ðŸŽ­ Playwright SDK | ${{ needs.playwright-sdk.result }} | $([ '${{ needs.playwright-sdk.result }}' = 'success' ] && echo 'âœ… Passed' || echo 'âŒ Failed') |"
            echo ""
          } | tee -a $GITHUB_STEP_SUMMARY > $REPORT_FILE

          # Check individual test failures for better error reporting
          LINT_FAILED="${{ needs.static-analysis-and-tests.outputs.lint_result == 'failure' }}"
          TSC_FAILED="${{ needs.static-analysis-and-tests.outputs.tsc_result == 'failure' }}"
          UNIT_FAILED="${{ needs.static-analysis-and-tests.outputs.unit_tests_result == 'failure' }}"
          IMAGES_FAILED="${{ needs.static-analysis-and-tests.outputs.images_result == 'failure' }}"
          COLORS_FAILED="${{ needs.static-analysis-and-tests.outputs.colors_result == 'failure' }}"
          LOCALES_FAILED="${{ needs.static-analysis-and-tests.outputs.locales_result == 'failure' }}"
          DEPS_FAILED="${{ needs.static-analysis-and-tests.outputs.dependencies_result == 'failure' }}"

          # Calculate test statistics
          PASSED_TESTS=0
          FAILED_TESTS=0
          SKIPPED_TESTS=0
          
          # Count test results - properly handle empty/null values
          declare -a results=(
            "${{ needs.changes.result }}"
            "${{ needs.static-analysis-and-tests.outputs.lint_result || 'skipped' }}"
            "${{ needs.static-analysis-and-tests.outputs.tsc_result || 'skipped' }}"
            "${{ needs.static-analysis-and-tests.outputs.unit_tests_result || 'skipped' }}"
            "${{ needs.static-analysis-and-tests.outputs.images_result || 'skipped' }}"
            "${{ needs.static-analysis-and-tests.outputs.colors_result || 'skipped' }}"
            "${{ needs.static-analysis-and-tests.outputs.locales_result || 'skipped' }}"
            "${{ needs.static-analysis-and-tests.outputs.dependencies_result || 'skipped' }}"
            "${{ needs.playwright-login.result }}"
            "${{ needs.playwright-sdk.result }}"
          )
          
          for result in "${results[@]}"; do
            if [[ "$result" == "success" ]]; then
              ((PASSED_TESTS++))
            elif [[ "$result" == "failure" ]]; then
              ((FAILED_TESTS++))
            else
              ((SKIPPED_TESTS++))
            fi
          done
          
          TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS + SKIPPED_TESTS))
          
          # Add detailed analysis section with safe percentage calculation
          {
            echo "## ðŸ“ˆ Test Statistics"
            echo ""
            echo "| Metric | Count | Percentage |"
            echo "|--------|-------|------------|"
            if [[ $TOTAL_TESTS -gt 0 ]]; then
              echo "| âœ… **Passed** | $PASSED_TESTS | $(( PASSED_TESTS * 100 / TOTAL_TESTS ))% |"
              echo "| âŒ **Failed** | $FAILED_TESTS | $(( FAILED_TESTS * 100 / TOTAL_TESTS ))% |"
              echo "| â­ï¸ **Skipped** | $SKIPPED_TESTS | $(( SKIPPED_TESTS * 100 / TOTAL_TESTS ))% |"
            else
              echo "| âœ… **Passed** | $PASSED_TESTS | 0% |"
              echo "| âŒ **Failed** | $FAILED_TESTS | 0% |"
              echo "| â­ï¸ **Skipped** | $SKIPPED_TESTS | 0% |"
            fi
            echo "| ðŸ“Š **Total** | $TOTAL_TESTS | 100% |"
            echo ""
          } | tee -a $GITHUB_STEP_SUMMARY >> $REPORT_FILE

          # Check if any critical tests failed and write detailed analysis
          if [[ "$LINT_FAILED" == "true" ]] || [[ "$TSC_FAILED" == "true" ]] || [[ "$UNIT_FAILED" == "true" ]] || 
             [[ "$DEPS_FAILED" == "true" ]]; then
            {
              echo "## âŒ Critical Test Failures"
              echo ""
              echo "> **âš ï¸ Build Status: FAILED** - Critical tests have failed and must be fixed before deployment."
              echo ""
              echo "### Failed Tests:"
              [[ "$LINT_FAILED" == "true" ]] && echo "- **ðŸ” ESLint**: Code quality issues detected. Run \`pnpm lint:fix\` to auto-fix issues."
              [[ "$TSC_FAILED" == "true" ]] && echo "- **ðŸ”§ TypeScript**: Compilation errors found. Check type definitions and syntax."
              [[ "$UNIT_FAILED" == "true" ]] && echo "- **ðŸ§ª Unit Tests**: Test failures detected. Review test output and fix failing tests."
              [[ "$DEPS_FAILED" == "true" ]] && echo "- **ðŸ”’ Dependencies**: Security vulnerabilities or dependency issues found. Review audit results."
              echo ""
              echo "### ðŸ”§ Recommended Actions:"
              echo "1. Review the failed test logs above"
              echo "2. Fix the identified issues locally"
              echo "3. Run tests locally to verify fixes"
              echo "4. Commit and push the fixes"
              echo ""
            } | tee -a $GITHUB_STEP_SUMMARY >> $REPORT_FILE
            exit 1
          elif [[ "$IMAGES_FAILED" == "true" ]] || [[ "$COLORS_FAILED" == "true" ]] || [[ "$LOCALES_FAILED" == "true" ]] ||
                [[ "${{ needs.playwright-login.result }}" == "failure" ]] || [[ "${{ needs.playwright-sdk.result }}" == "failure" ]]; then
            {
              echo "## âš ï¸ Non-Critical Test Failures"
              echo ""
              echo "> **âœ… Build Status: PASSED** - Build can continue, but some tests need attention."
              echo ""
              echo "### Failed Tests:"
              [[ "$IMAGES_FAILED" == "true" ]] && echo "- **ðŸ–¼ï¸ Images Tests**: Image validation issues. Check image formats and sizes."
              [[ "$COLORS_FAILED" == "true" ]] && echo "- **ðŸŽ¨ Colors Tests**: Color scheme validation failed. Review color definitions."
              [[ "$LOCALES_FAILED" == "true" ]] && echo "- **ðŸŒ Locales Tests**: Translation or localization issues. Check translation files."
              [[ "${{ needs.playwright-login.result }}" == "failure" ]] && echo "- **ðŸŽ­ Playwright Login**: E2E login tests failed. Check authentication flow."
              [[ "${{ needs.playwright-sdk.result }}" == "failure" ]] && echo "- **ðŸŽ­ Playwright SDK**: E2E SDK tests failed. Check SDK integration."
              echo ""
              echo "### ðŸ“ Recommended Actions:"
              echo "1. Review the failed test details"
              echo "2. Address issues in the next development cycle"
              echo "3. Monitor for recurring patterns"
              echo ""
            } | tee -a $GITHUB_STEP_SUMMARY >> $REPORT_FILE
            exit 0
          else
            {
              echo "## âœ… All Tests Passed!"
              echo ""
              echo "> **ðŸŽ‰ Build Status: SUCCESS** - All tests passed successfully!"
              echo ""
              echo "### ðŸ† Achievement Unlocked:"
              echo "- All static analysis checks passed"
              echo "- All unit tests passed"
              echo "- All asset validation passed"
              echo "- All security checks passed"
              echo "- All E2E tests passed"
              echo ""
              echo "**Ready for deployment! ðŸš€**"
              echo ""
            } | tee -a $GITHUB_STEP_SUMMARY >> $REPORT_FILE
            exit 0
          fi
      - name: Upload Test Results Report
        uses: actions/upload-artifact@v4
        with:
          name: test-results-report
          path: report.md
          retention-days: 2
