name: Frontend common tests

on:
  push:
    branches: [develop, release/v*, hotfix/v*]
    paths:
      [packages/**, common/**, .github/workflows/frontend-common-tests.yaml]
  pull_request:
    branches: [develop, release/v*, hotfix/v*]
    paths:
      [packages/**, common/**, .github/workflows/frontend-common-tests.yaml]

env:
  NODE_VERSION: 22.x
  PNPM_VERSION: 10.15.1

jobs:
  # Detect changes to optimize job execution
  changes:
    name: "Detect changes"
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.changes.outputs.packages }}
      common: ${{ steps.changes.outputs.common }}
      playwright: ${{ steps.changes.outputs.playwright }}
      locales: ${{ steps.changes.outputs.locales }}
      workflow: ${{ steps.changes.outputs.workflow }}
      any_changes: ${{ steps.changes.outputs.any_changes }}
      lint: ${{ steps.changes.outputs.packages }}
      tsc: ${{ steps.changes.outputs.packages }}
      unit-tests: ${{ steps.changes.outputs.packages }}
      images: ${{ steps.changes.outputs.common }}
      colors: ${{ steps.changes.outputs.common }}
      dependencies: ${{ steps.changes.outputs.packages }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect file changes
        id: changes
        run: |
          # Get the base branch for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          # If BASE_SHA is empty or all zeros, compare with HEAD~1
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="HEAD~1"
          fi

          echo "Comparing against: $BASE_SHA"

          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_SHA HEAD || echo "")
          echo "Changed files: $CHANGED_FILES"

          # Check for packages changes
          if echo "$CHANGED_FILES" | grep -q "^packages/"; then
            echo "packages=true" >> $GITHUB_OUTPUT
            echo "âœ… Packages changes detected"
          else
            echo "packages=false" >> $GITHUB_OUTPUT
            echo "âŒ No packages changes"
          fi

          # Check for common changes
          if echo "$CHANGED_FILES" | grep -q "^common/"; then
            echo "common=true" >> $GITHUB_OUTPUT
            echo "âœ… Common changes detected"
          else
            echo "common=false" >> $GITHUB_OUTPUT
            echo "âŒ No common changes"
          fi

          # Check for playwright changes
          if echo "$CHANGED_FILES" | grep -E "^packages/(login|sdk)/"; then
            echo "playwright=true" >> $GITHUB_OUTPUT
            echo "âœ… Playwright changes detected"
          else
            echo "playwright=false" >> $GITHUB_OUTPUT
            echo "âŒ No playwright changes"
          fi

          # Check for locales changes
          if echo "$CHANGED_FILES" | grep -E "(public/locales/|common/tests/)"; then
            echo "locales=true" >> $GITHUB_OUTPUT
            echo "âœ… Locales changes detected"
          else
            echo "locales=false" >> $GITHUB_OUTPUT
            echo "âŒ No locales changes"
          fi

          # Check for workflow changes
          if echo "$CHANGED_FILES" | grep -q "^\.github/workflows/"; then
            echo "workflow=true" >> $GITHUB_OUTPUT
            echo "âœ… Workflow changes detected"
          else
            echo "workflow=false" >> $GITHUB_OUTPUT
            echo "âŒ No workflow changes"
          fi

          # Set any_changes flag
          if echo "$CHANGED_FILES" | grep -E "(^packages/|^common/|^\.github/workflows/)"; then
            echo "any_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Any relevant changes detected"
          else
            echo "any_changes=false" >> $GITHUB_OUTPUT
            echo "âŒ No relevant changes detected"
          fi

  # Combined static analysis and common tests
  static-analysis-and-tests:
    name: "Static Analysis & Tests"
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.packages == 'true' || needs.changes.outputs.common == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 15
    outputs:
      lint_result: ${{ steps.lint.outputs.result }}
      tsc_result: ${{ steps.tsc.outputs.result }}
      unit_tests_result: ${{ steps.unit-tests.outputs.result }}
      images_result: ${{ steps.images.outputs.result }}
      colors_result: ${{ steps.colors.outputs.result }}
      locales_result: ${{ steps.locales.outputs.result }}
      dependencies_result: ${{ steps.dependencies.outputs.result }}
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      # Install all dependencies
      - name: Install pnpm dependencies
        run: pnpm install --frozen-lockfile
      - name: Install common test npm dependencies
        working-directory: ./common/tests
        run: npm ci --prefer-offline

      # Run ESLint (if needed)
      - name: Run ESLint
        id: lint
        if: needs.changes.outputs.lint == 'true' || needs.changes.outputs.workflow == 'true'
        run: |
          echo "ðŸ” Running ESLint..."
          if pnpm lint; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… ESLint passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ ESLint failed"
            exit 1
          fi
        continue-on-error: true

      # Run TypeScript compilation (if needed)
      - name: Run TypeScript compilation
        id: tsc
        if: needs.changes.outputs.tsc == 'true' || needs.changes.outputs.workflow == 'true'
        run: |
          echo "ðŸ”§ Running TypeScript compilation..."
          if pnpm tsc; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… TypeScript compilation passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ TypeScript compilation failed"
            exit 1
          fi
        continue-on-error: true

      # Run images tests (if needed)
      - name: Run images tests
        id: images
        if: needs.changes.outputs.images == 'true' || needs.changes.outputs.workflow == 'true'
        working-directory: ./common/tests
        run: |
          echo "ðŸ–¼ï¸ Running images tests..."
          if npm run test:images; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… Images tests passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Images tests failed"
            exit 1
          fi
        continue-on-error: true

      # Run colors tests (if needed)
      - name: Run colors tests
        id: colors
        if: needs.changes.outputs.colors == 'true' || needs.changes.outputs.workflow == 'true'
        working-directory: ./common/tests
        run: |
          echo "ðŸŽ¨ Running colors tests..."
          if npm run test:colors; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… Colors tests passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Colors tests failed"
            exit 1
          fi
        continue-on-error: true

      # Run locales tests (if needed)
      - name: Run locales tests
        id: locales
        if: needs.changes.outputs.locales == 'true' || needs.changes.outputs.workflow == 'true'
        working-directory: ./common/tests
        run: |
          echo "ðŸŒ Running locales tests..."
          if npm run test:skip-base-languages; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… Locales tests passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Locales tests failed"
            exit 1
          fi
        continue-on-error: true

      # Run dependencies audit and tests (if needed)
      - name: Run dependencies audit and tests
        id: dependencies
        if: needs.changes.outputs.dependencies == 'true' || needs.changes.outputs.workflow == 'true'
        run: |
          echo "ðŸ”’ Running dependencies audit..."
          AUDIT_SUCCESS=true
          DEPS_TEST_SUCCESS=true

          # Run pnpm audit
          if ! pnpm audit --audit-level=moderate; then
            echo "âŒ Dependencies audit failed"
            AUDIT_SUCCESS=false
          else
            echo "âœ… Dependencies audit passed"
          fi

          # Run dependency tests
          echo "ðŸ” Running dependency tests..."
          cd ./common/tests
          if ! npm run test:dependencies; then
            echo "âŒ Dependency tests failed"
            DEPS_TEST_SUCCESS=false
          else
            echo "âœ… Dependency tests passed"
          fi

          # Set overall result
          if [[ "$AUDIT_SUCCESS" == "true" ]] && [[ "$DEPS_TEST_SUCCESS" == "true" ]]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… All dependency checks passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Some dependency checks failed"
            exit 1
          fi
        continue-on-error: true
        env:
          CI: true

      # Run unit tests (if needed)
      - name: Run unit tests
        id: unit-tests
        if: needs.changes.outputs.unit-tests == 'true' || needs.changes.outputs.workflow == 'true'
        run: |
          echo "ðŸ§ª Running unit tests..."
          if pnpm test; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "âœ… Unit tests passed"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "âŒ Unit tests failed"
            exit 1
          fi
        continue-on-error: true

  # Playwright Login tests
  playwright-login:
    name: "Login e2e tests"
    runs-on: ubuntu-latest
    needs: [changes, static-analysis-and-tests]
    if: needs.changes.outputs.playwright == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Cleanup existing containers
        run: docker ps -a --filter name=login-tests-ci -q | xargs -r docker rm -f
      - uses: adambirds/docker-compose-action@v1.5.0
        with:
          compose-file: packages/login/compose.yaml
          up-flags: --build --force-recreate --remove-orphans
          down-flags: --volumes --remove-orphans
          services: tests-ci
          test-container: tests-ci
          test-command: pnpm exec playwright test
          environment: |
            CI=true
            GITHUB_WORKFLOW=${{ github.workflow }}
            GITHUB_RUN_ID=${{ github.run_id }}
            GITHUB_RUN_NUMBER=${{ github.run_number }}

  # Playwright SDK tests
  playwright-sdk:
    name: "SDK e2e tests"
    runs-on: ubuntu-latest
    needs: [changes, static-analysis-and-tests]
    if: needs.changes.outputs.playwright == 'true' || needs.changes.outputs.workflow == 'true'
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - name: Cleanup existing containers
        run: docker ps -a --filter name=sdk-tests-ci -q | xargs -r docker rm -f
      - uses: adambirds/docker-compose-action@v1.5.0
        with:
          compose-file: packages/sdk/compose.yaml
          up-flags: --build --force-recreate --remove-orphans
          down-flags: --volumes --remove-orphans
          services: tests-ci
          test-container: tests-ci
          test-command: pnpm exec playwright test
          environment: |
            CI=true
            GITHUB_WORKFLOW=${{ github.workflow }}
            GITHUB_RUN_ID=${{ github.run_id }}
            GITHUB_RUN_NUMBER=${{ github.run_number }}

  # Summary job to report overall status
  test-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    needs:
      [changes, static-analysis-and-tests, playwright-login, playwright-sdk]
    if: always()
    timeout-minutes: 2
    steps:
      - name: Check test results
        run: |
          # Create report file
          REPORT_FILE="report.md"

          # Write test results to both GitHub Step Summary and report file
          {
            echo "## Test Results Summary"
            echo "| Test Type | Status |"
            echo "|-----------|--------|"
            echo "| Changes Detection | ${{ needs.changes.result }} |"
            echo ""
            echo "# Individual test results from merged job"
            echo "| ðŸ” ESLint | ${{ needs.static-analysis-and-tests.outputs.lint_result || 'skipped' }} |"
            echo "| ðŸ”§ TypeScript | ${{ needs.static-analysis-and-tests.outputs.tsc_result || 'skipped' }} |"
            echo "| ðŸ§ª Unit Tests | ${{ needs.static-analysis-and-tests.outputs.unit_tests_result || 'skipped' }} |"
            echo "| ðŸ–¼ï¸ Images Tests | ${{ needs.static-analysis-and-tests.outputs.images_result || 'skipped' }} |"
            echo "| ðŸŽ¨ Colors Tests | ${{ needs.static-analysis-and-tests.outputs.colors_result || 'skipped' }} |"
            echo "| ðŸŒ Locales Tests | ${{ needs.static-analysis-and-tests.outputs.locales_result || 'skipped' }} |"
            echo "| ðŸ”’ Dependencies | ${{ needs.static-analysis-and-tests.outputs.dependencies_result || 'skipped' }} |"
            echo ""
            echo "# Other jobs"
            echo "| Playwright Login | ${{ needs.playwright-login.result }} |"
            echo "| Playwright SDK | ${{ needs.playwright-sdk.result }} |"
          } | tee -a $GITHUB_STEP_SUMMARY > $REPORT_FILE

          # Check individual test failures for better error reporting
          LINT_FAILED="${{ needs.static-analysis-and-tests.outputs.lint_result == 'failure' }}"
          TSC_FAILED="${{ needs.static-analysis-and-tests.outputs.tsc_result == 'failure' }}"
          UNIT_FAILED="${{ needs.static-analysis-and-tests.outputs.unit_tests_result == 'failure' }}"
          IMAGES_FAILED="${{ needs.static-analysis-and-tests.outputs.images_result == 'failure' }}"
          COLORS_FAILED="${{ needs.static-analysis-and-tests.outputs.colors_result == 'failure' }}"
          LOCALES_FAILED="${{ needs.static-analysis-and-tests.outputs.locales_result == 'failure' }}"
          DEPS_FAILED="${{ needs.static-analysis-and-tests.outputs.dependencies_result == 'failure' }}"

          # Check if any critical tests failed and write to both summary and report
          if [[ "$LINT_FAILED" == "true" ]] || [[ "$TSC_FAILED" == "true" ]] || [[ "$UNIT_FAILED" == "true" ]] || 
             [[ "$DEPS_FAILED" == "true" ]]; then
            {
              echo ""
              echo "âŒ **Critical tests failed:**"
              [[ "$LINT_FAILED" == "true" ]] && echo "- ESLint issues found"
              [[ "$TSC_FAILED" == "true" ]] && echo "- TypeScript compilation errors"
              [[ "$UNIT_FAILED" == "true" ]] && echo "- Unit test failures"
              [[ "$DEPS_FAILED" == "true" ]] && echo "- Dependency audit issues"
            } | tee -a $GITHUB_STEP_SUMMARY >> $REPORT_FILE
            exit 1
          elif [[ "$IMAGES_FAILED" == "true" ]] || [[ "$COLORS_FAILED" == "true" ]] || [[ "$LOCALES_FAILED" == "true" ]] ||
                [[ "${{ needs.playwright-login.result }}" == "failure" ]] || [[ "${{ needs.playwright-sdk.result }}" == "failure" ]]; then
            {
              echo ""
              echo "âš ï¸ **Some tests failed, but build can continue:**"
              [[ "$IMAGES_FAILED" == "true" ]] && echo "- Images test issues"
              [[ "$COLORS_FAILED" == "true" ]] && echo "- Colors test issues"
              [[ "$LOCALES_FAILED" == "true" ]] && echo "- Locales test issues"
              [[ "${{ needs.playwright-login.result }}" == "failure" ]] && echo "- Login e2e test failures"
              [[ "${{ needs.playwright-sdk.result }}" == "failure" ]] && echo "- SDK e2e test failures"
            } | tee -a $GITHUB_STEP_SUMMARY >> $REPORT_FILE
            exit 0
          else
            {
              echo ""
              echo "âœ… **All tests passed successfully!**"
            } | tee -a $GITHUB_STEP_SUMMARY >> $REPORT_FILE
            exit 0
          fi
      - name: Upload Test Results Report
        uses: actions/upload-artifact@v4
        with:
          name: test-results-report
          path: report.md
          retention-days: 2
